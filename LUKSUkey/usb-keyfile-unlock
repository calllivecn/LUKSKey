#!/bin/sh
# --> /etc/initramfs-tools/scripts/local-top/usb-keyfile-unlock

PREREQ=""

prereqs() {
    echo "$PREREQ"
}

case "$1" in
    prereqs)
        prereqs
        exit 0
        ;;
esac

. /scripts/functions

CONF="/etc/usb-keyfile.conf"

if [ -r "$CONF" ];then
    . "$CONF"
else
    info "$CONF not configure, exit"
    return 1
fi

if [ -z "$USB_UUID" ] || [ -z "$KEYFILE_PATH" ] || [ -z "$NAME_LUKS" ] || [ -z "$LUKS_UUID" ];then
    warn "USB_UUID KEYFILE_PATH NAME_LUKS LUKS_UUID, require configure."
    return 1
fi



LUKS_DEV=$(blkid -t "UUID=$LUKS_UUID" -o device 2>/dev/null)
if [ -z "$LUKS_DEV" ];then
    warn "not found LUKS UUID: $LUKS_UUID"
    return 1
fi


usb_unlock(){
    
    local RUN_USB="/run/usb"
    udevadm wait -t 30 "/dev/disk/by-uuid/$USB_UUID"
    # 使用 blkid 查找设备
    USB_DEV=$(blkid -t "UUID=$USB_UUID" -o device 2>/dev/null)

    if [ -n "$USB_DEV" ]; then
        info "USB device found: $USB_DEV UUID=$USB_UUID"

        mkdir -p $RUN_USB

        if mount -vt auto -U "$USB_UUID" $RUN_USB; then
            info "USB mounted successfully"
    
            KEYFILE="${RUN_USB}$KEYFILE_PATH"
            if [ -r "$KEYFILE" ]; then
                info "Keyfile found, attempting unlock..."
                systemd-cryptsetup attach "$NAME_LUKS" "$LUKS_DEV" "${RUN_USB}${KEYFILE_PATH}"
                info "LUKS Root unlock done."
                umount $RUN_USB
                rmdir $RUN_USB
                return 0
            else
                warn "Keyfile not found: $KEYFILE"
                return 1
            fi
            umount $RUN_USB
        else
            warn "Failed to mount USB device"
            return 1
        fi
    else
        warn "USB device with UUID=$USB_UUID not found"
        return 1
    fi
}

if usb_unlock; then
    log_end_msg 0
    exit 0
else

    log_begin_msg "Attempting to unlock LUKS using USB keyfile..."

    # === 回退到交互式密码输入 ===
    log_begin_msg "Falling back to manual password entry..."
    echo
    echo "USB keyfile not available or invalid."
    echo "Please unlock LUKS manually via console (if configured)."
    echo

    # 此时 cryptroot 脚本会自动等待从 /lib/cryptsetup/passfifo 读取密码
    # 用户可通过本地控制台输入，或通过 dropbear SSH 登录后写入 passfifo

    log_end_msg 0

fi 
